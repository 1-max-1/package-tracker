{% from "includes/form_renderer.html" import render_form %}
{% extends "main_layout_container.html" %}
{% block body %}
	<script type="text/javascript">
		// When a modal's submit button is clicked, we need some way of getting the package ID that
		// the modal is for. This function is called just before the modal is opened. It will put the
		// package ID into a hidden input on the modal so it can be retrieved later.
		function assignPackageIDToModal(packageID) {
			$(".packageIDHolder").val(parseInt(packageID));
		}

		// Called when the user clicks the dialog button to rename or delete their package.
		// modalName should be the css ID of the modal that called this function.
		function handleModalSubmit(modalName) {
			// Disable the 3 buttons
			$(".xButton").prop("disabled", true);
			$(".cancelButton").prop("disabled", true);
			$(".updateButton").prop("disabled", true);

			// Add HTML - this is a little bootstrap spinner loading thing
			$(".modal-footer").append('<div class="spinner-border text-primary maxsSpinner" role="status"><span class="visually-hidden">Loading...</span></div>');
			// Make the error message hidden - new request, no error
			$(".modalErrorMessage").removeClass("d-inline");
			$(".modalErrorMessage").addClass("d-none");

			var packageID = $(".packageIDHolder").val();

			// This request will send the request to the flask endpoint
			var xhttp = new XMLHttpRequest();
  			xhttp.onreadystatechange = () => {
				// State = 4 means request has completed
    			if (xhttp.readyState == 4) {
					// Remove loading indicator and re-enable all of the buttons
      				$(".maxsSpinner").remove();
					$(".xButton").prop("disabled", false);
					$(".cancelButton").prop("disabled", false);
					$(".updateButton").prop("disabled", false);

					// If the request was a success then we can hide the modal
					if(xhttp.status == 200 && xhttp.responseText != "0") {
						// Update the package label with the new title
						if(modalName == "titleInputModal")
							$("#packageLabel-" + packageID).text(xhttp.responseText);
						else if(modalName == "deleteModal")
							removePackageFromList(packageID);
						bootstrap.Modal.getInstance(document.getElementById(modalName)).hide();
					}
					// If it failed then we show the error messge
					else {
						$(".modalErrorMessage").removeClass("d-none");
						$(".modalErrorMessage").addClass("d-inline");
					}
    			}
  			};

			// Send the request to flask - contains new title and package ID,
			// or just the package ID if we are deleting.
			// Encode the paramters to stay safe :-) !!!
			if(modalName == "titleInputModal"){
				xhttp.open("POST", "updatePackageTitle", true);
				xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
				xhttp.send("newTitle=" + encodeURIComponent($("#new-title-input").val()) + "&packageID=" + encodeURIComponent(packageID));
			}
			else if(modalName == "deleteModal") {
				xhttp.open("POST", "deletePackage", true);
				xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
				xhttp.send("packageID=" + encodeURIComponent(packageID));
			}
		}

		function removePackageFromList(id) {
			// First, remove it from the list
			$("#packageListLI-" + id).remove();
			// If there are no more packages, then we need to add the default prompt
			if($("#packageListUL li").length == 0)
				$("#packageListUL").append('<li class="list-group-item">You are not tracking any packages. Add one!</li>');
		}
	</script>

	<!-- This form will submit to itself -->
	<form action="" method="POST">
		<!-- The renderer does all of the work of getting the fields and adding them to the html -->
		{{render_form(form)}}
		<input type="submit" class="btn btn-primary" style="display: inline;" value="Go"/>
	</form>

	<!-- Below the form, we render each package the user is tracking in a list. These are passed in -->
	<ul class="list-group" id="packageListUL">	
		{% if not packageList %}
			<li class="list-group-item">You are not tracking any packages. Add one!</li>
		<!-- If there are some things in the list then we loop through them -->
		{% else %}
			{% for package in packageList %}
				<li class="list-group-item" id="packageListLI-{{package['id']}}">
					<!-- Render the package title -->
					<p class="d-inline-block" id="packageLabel-{{package['id']}}">{{ package["title"] }}</p>
					<!-- Button with link to package details page for this package -->
					<a role="button" class="btn btn-outline-primary" href="/packageDetails/{{package['id']}}">View details</a>
					<!-- Button that opens the title input modal -->
					<button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#titleInputModal" onclick="assignPackageIDToModal(`{{package['id']}}`)">Change title</button>
					<!-- Opens deletion modal -->
					<button type="button" class="btn btn-outline-danger d-inline-block" data-bs-toggle="modal" data-bs-target="#deleteModal" onclick="assignPackageIDToModal(`{{package['id']}}`)">Delete</button>

					<!-- If the package hasn't been updated for 3 weeks, then we show a little alert -->
					{% if package["current_time"] - package["last_new_data"] > 2160000 %}
						<p class="text-warning d-inline-block"><span class="border border-warning">This package is old and hasn't been updated for a while. Consider deleting it? Or, <a href="/renewPackage/{{package['id']}}">renew</a> it.</span></p>
					{% endif %}
				</li>
			{% endfor %}
		{% endif %}
	</ul>

	<!-- This is the modal dialog allowing the user to input text for their package title -->
	<div class="modal fade" id="titleInputModal" tabindex="-1" aria-labelledby="titleInputModal" aria-hidden="true">
		<div class="modal-dialog">
		  	<div class="modal-content">
				<!-- The header of the dialog - title bar and stuff -->
				<div class="modal-header">
			  		<h5 class="modal-title">Enter New Title:</h5>
					<!-- Second close button - X in top corner -->
			  		<button type="button" class="btn-close xButton" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<input type="text" class="form-control" id="new-title-input">
					<!-- If there is an error then this error message will be unhidden by jqery -->
					<p class="text-danger d-none modalErrorMessage">Couldn't update title. Please try again.</p>
					<!-- This will hold the package ID of the package that this modal is for -->
					<input type="hidden" class="packageIDHolder">
				</div>
				<!-- The submit and cancel button -->
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary cancelButton" data-bs-dismiss="modal">Cancel</button>
					<button type="button" class="btn btn-primary updateButton" onclick="handleModalSubmit('titleInputModal')">Update title</button>
				</div>
			</div>
		</div>
	</div>

	<!-- This is the modal dialog allowing the user to delete their package -->
	<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="titleInputModal" aria-hidden="true">
		<div class="modal-dialog">
		  	<div class="modal-content">
				<!-- The header of the dialog - title bar and stuff -->
				<div class="modal-header">
			  		<h5 class="modal-title">Are you sure?</h5>
					<!-- Second close button - X in top corner -->
			  		<button type="button" class="btn-close xButton" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<p>This cannot be undone.</p>
					<!-- If there is an error then this error message will be unhidden by jqery -->
					<p class="text-danger d-none modalErrorMessage">Couldn't delete package. Please try again.</p>
					<!-- This will hold the package ID of the package that this modal is for -->
					<input type="hidden" class="packageIDHolder">
				</div>
				<!-- The submit and cancel button -->
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary cancelButton" data-bs-dismiss="modal">Cancel</button>
					<button type="button" class="btn btn-danger updateButton" onclick="handleModalSubmit('deleteModal')">Yes delete.</button>
				</div>
			</div>
		</div>
	</div>
{% endblock %}